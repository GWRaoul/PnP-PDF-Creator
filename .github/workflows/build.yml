name: Mac .app bauen (Doppelklick)

on:
  workflow_dispatch:

jobs:
  build-mac:
    runs-on: macos-latest

    steps:
      - name: Code holen
        uses: actions/checkout@v4

      - name: Python einrichten
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Abhängigkeiten installieren
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Sicherstellen, dass rich + questionary wirklich installiert sind
          pip install rich questionary

      # 1) PyInstaller Build (ONEDIR wird zuverlässig eingebettet)
      - name: Build mit PyInstaller
        run: |
          pyinstaller --clean --noconfirm \
            --name "PnP PDF Creator" \
            --icon "PnP_PDF_Creator.icns" \
            --onedir \
            PnP_PDF_Creator.py

      # 2) Wrapper-App erzeugen (macOS .app, die Terminal öffnet)
      - name: Wrapper .app erstellen (Doppelklick → Terminal)
        run: |
          set -e

          echo "== dist Inhalt =="
          ls -la dist

          # Sicherstellen, dass PyInstaller-Ausgabe korrekt ist
          if [ ! -d "dist/PnP PDF Creator" ]; then
            echo "❌ dist/PnP PDF Creator fehlt."
            exit 1
          fi

          if [ ! -f "dist/PnP PDF Creator/PnP PDF Creator" ]; then
            echo "❌ Binary fehlt."
            ls -la "dist/PnP PDF Creator"
            exit 1
          fi

          chmod +x "dist/PnP PDF Creator/PnP PDF Creator"

          # AppleScript: Terminal öffnen & Programm starten
          cat > launcher.applescript <<'APPLESCRIPT'
          on run
              set appName to "PnP PDF Creator"
              set bundlePath to POSIX path of (path to me)
              set toolDir to bundlePath & "Contents/Resources/tool/"
              set exePath to toolDir & appName

              tell application "Terminal"
                  activate
                  do script "cd " & quoted form of toolDir & " && " & quoted form of exePath
              end tell
          end run
          APPLESCRIPT

          # .app aus dem AppleScript erzeugen
          osacompile -o "PnP PDF Creator.app" launcher.applescript

          # Icon kopieren
          mkdir -p "PnP PDF Creator.app/Contents/Resources"
          cp "PnP_PDF_Creator.icns" "PnP PDF Creator.app/Contents/Resources/applet.icns"

          # PyInstaller-Output in .app einbetten
          mkdir -p "PnP PDF Creator.app/Contents/Resources/tool"
          cp -R "dist/PnP PDF Creator/." "PnP PDF Creator.app/Contents/Resources/tool/"

          # Minimaler Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleName 'PnP PDF Creator'" "PnP PDF Creator.app/Contents/Info.plist" || true
          /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName 'PnP PDF Creator'" "PnP PDF Creator.app/Contents/Info.plist" || true

          echo "✅ Wrapper-App erstellt:"
          ls -la "PnP PDF Creator.app"

      # 3) Ad-hoc signieren (macOS sonst „beschädigt“ Warnung)
      - name: Wrapper-App ad-hoc signieren
        run: |
          codesign --force --deep --sign - "PnP PDF Creator.app"
          codesign -dv --verbose=2 "PnP PDF Creator.app" || true

      # 4) ZIP erzeugen für Release / Download
      - name: Wrapper-App verpacken
        run: |
          ditto -c -k --sequesterRsrc --keepParent \
            "PnP PDF Creator.app" \
            "PnP_PDF_Creator_macOS_APP.zip"

      - name: Artefakt hochladen
        uses: actions/upload-artifact@v4
        with:
          name: PnP_PDF_Creator_macOS_APP
          path: PnP_PDF_Creator_macOS_APP.zip
