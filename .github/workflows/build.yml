name: macOS Wrapper .app + DMG (Doppelklick startet Terminal)
on:
  workflow_dispatch:

jobs:
  build-mac:
    runs-on: macos-latest

    steps:
      - name: Code holen
        uses: actions/checkout@v4

      - name: Python einrichten
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Abhängigkeiten installieren
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: create-dmg installieren
        run: |
          brew update
          brew install create-dmg

      # 1) PyInstaller: onedir CLI Build (mit Konsole)
      - name: Build mit PyInstaller (CLI, onedir)
        run: |
          set -euo pipefail
          test -f "PnP_PDF_Creator.py"
          test -f "PnP_PDF_Creator.icns"

          pyinstaller --clean --noconfirm \
            --name "PnP PDF Creator" \
            --icon "PnP_PDF_Creator.icns" \
            --onedir \
            PnP_PDF_Creator.py

          echo "== dist Inhalt =="
          ls -la dist
          test -d "dist/PnP PDF Creator"
          test -f "dist/PnP PDF Creator/PnP PDF Creator"
          chmod +x "dist/PnP PDF Creator/PnP PDF Creator"

      # 2) Wrapper .app erstellen, die Terminal öffnet und die CLI startet
      - name: Wrapper .app erstellen (Terminal do script)
        run: |
          set -euo pipefail

          cat > launcher.applescript <<'APPLESCRIPT'
          on run
            set appName to "PnP PDF Creator"
            set bundlePath to POSIX path of (path to me)
            set toolDir to bundlePath & "Contents/Resources/tool/"
            set exePath to toolDir & appName

            set cmd to "cd " & quoted form of toolDir & "; " & quoted form of exePath

            tell application "Terminal"
              activate
              do script cmd
            end tell
          end run
          APPLESCRIPT

          # .app aus AppleScript bauen
          osacompile -o "PnP PDF Creator.app" launcher.applescript

          # Icon setzen (Applet Icon)
          mkdir -p "PnP PDF Creator.app/Contents/Resources"
          cp "PnP_PDF_Creator.icns" "PnP PDF Creator.app/Contents/Resources/applet.icns"

          # PyInstaller Output einbetten
          mkdir -p "PnP PDF Creator.app/Contents/Resources/tool"
          cp -R "dist/PnP PDF Creator/." "PnP PDF Creator.app/Contents/Resources/tool/"

          echo "== Wrapper gebaut =="
          ls -la "PnP PDF Creator.app"

      # 3) Ad-hoc signieren (optional)
      - name: Wrapper-App ad-hoc signieren
        run: |
          codesign --force --deep --sign - "PnP PDF Creator.app" || true
          codesign -dv --verbose=2 "PnP PDF Creator.app" || true

      # 4) ZIP (optional)
      - name: Wrapper-App als ZIP verpacken
        run: |
          ditto -c -k --sequesterRsrc --keepParent \
            "PnP PDF Creator.app" \
            "PnP_PDF_Creator_macOS_APP.zip"

      # 5) DMG erstellen
      - name: DMG erstellen
        run: |
          rm -f "PnP_PDF_Creator_macOS.dmg"

          create-dmg \
            --volname "PnP PDF Creator" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --hide-extension "PnP PDF Creator.app" \
            --icon "PnP PDF Creator.app" 180 180 \
            --app-drop-link 420 180 \
            "PnP_PDF_Creator_macOS.dmg" \
            "PnP PDF Creator.app"

      # 6) Upload
      - name: Artefakte hochladen (ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: PnP_PDF_Creator_macOS_APP
          path: PnP_PDF_Creator_macOS_APP.zip

      - name: Artefakte hochladen (DMG)
        uses: actions/upload-artifact@v4
        with:
          name: PnP_PDF_Creator_macOS_DMG
          path: PnP_PDF_Creator_macOS.dmg
``
