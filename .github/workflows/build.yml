name: macOS .app + DMG bauen (PyInstaller, ohne Wrapper)
on:
  workflow_dispatch:

jobs:
  build-mac:
    runs-on: macos-latest

    steps:
      - name: Code holen
        uses: actions/checkout@v4

      - name: Python einrichten
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Abhängigkeiten installieren
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: create-dmg installieren
        run: |
          brew update
          brew install create-dmg

      # 1) PyInstaller: echte .app bauen (kein AppleScript-Wrapper!)
      - name: Build mit PyInstaller (macOS .app)
        run: |
          set -euo pipefail

          # Sanity checks: liegen Dateien wirklich im Root?
          test -f "PnP_PDF_Creator.py"
          test -f "requirements.txt"
          test -f "PnP_PDF_Creator.icns"

          pyinstaller --clean --noconfirm \
            --name "PnP PDF Creator" \
            --icon "PnP_PDF_Creator.icns" \
            --windowed \
            --onedir \
            PnP_PDF_Creator.py

          echo "== dist Inhalt =="
          ls -la dist

          # Prüfen, ob die .app existiert
          if [ ! -d "dist/PnP PDF Creator.app" ]; then
            echo "❌ dist/PnP PDF Creator.app fehlt."
            find dist -maxdepth 3 -type d -print
            exit 1
          fi

      # 2) Optional: Ad-hoc signieren (hilft oft gegen Warnungen)
      - name: App ad-hoc signieren
        run: |
          codesign --force --deep --sign - "dist/PnP PDF Creator.app" || true
          codesign -dv --verbose=2 "dist/PnP PDF Creator.app" || true

      # 3) ZIP (optional)
      - name: App als ZIP verpacken
        run: |
          ditto -c -k --sequesterRsrc --keepParent \
            "dist/PnP PDF Creator.app" \
            "PnP_PDF_Creator_macOS_APP.zip"

      # 4) DMG erstellen
      - name: DMG erstellen
        run: |
          set -euo pipefail
          rm -f "PnP_PDF_Creator_macOS.dmg"

          create-dmg \
            --volname "PnP PDF Creator" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --hide-extension "PnP PDF Creator.app" \
            --icon "PnP PDF Creator.app" 180 180 \
            --app-drop-link 420 180 \
            "PnP_PDF_Creator_macOS.dmg" \
            "dist/PnP PDF Creator.app"

      # 5) Optional: DMG ad-hoc signieren
      - name: DMG ad-hoc signieren
        run: |
          codesign --force --sign - "PnP_PDF_Creator_macOS.dmg" || true
          spctl -a -vv "PnP_PDF_Creator_macOS.dmg" || true

      # 6) Artefakte hochladen
      - name: Artefakte hochladen (ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: PnP_PDF_Creator_macOS_APP
          path: PnP_PDF_Creator_macOS_APP.zip

      - name: Artefakte hochladen (DMG)
        uses: actions/upload-artifact@v4
        with:
          name: PnP_PDF_Creator_macOS_DMG
          path: PnP_PDF_Creator_macOS.dmg
