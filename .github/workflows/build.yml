name: Mac .app + DMG bauen (Doppelklick)

on:
  workflow_dispatch:

jobs:
  build-mac:
    runs-on: macos-latest

    steps:
      # --- Code holen
      - name: Code holen
        uses: actions/checkout@v4

      # --- Python einrichten
      - name: Python einrichten
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --- Abhängigkeiten installieren
      - name: Abhängigkeiten installieren
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # --- (Optional) Homebrew-Tools für DMG
      # create-dmg ist das am weitesten verbreitete, einfache CLI zum Erzeugen schöner DMGs
      - name: create-dmg installieren
        run: |
          brew update
          brew install create-dmg

      # --- 1) PyInstaller-Build (ONEDIR wird zuverlässig eingebettet)
      - name: Build mit PyInstaller
        run: |
          pyinstaller --clean --noconfirm \
            --name "PnP PDF Creator" \
            --icon "PnP_PDF_Creator.icns" \
            --onedir \
            PnP_PDF_Creator.py

      # --- 2) Wrapper .app erzeugen (Doppelklick ? Terminal)
      - name: Wrapper .app erstellen (Doppelklick ? Terminal)
        run: |
          set -euo pipefail

          echo "== dist Inhalt =="
          ls -la dist

          # Sicherstellen, dass PyInstaller-Ausgabe korrekt ist
          if [ ! -d "dist/PnP PDF Creator" ]; then
            echo "? dist/PnP PDF Creator fehlt."
            exit 1
          fi

          if [ ! -f "dist/PnP PDF Creator/PnP PDF Creator" ]; then
            echo "? Binary fehlt."
            ls -la "dist/PnP PDF Creator"
            exit 1
          fi

          chmod +x "dist/PnP PDF Creator/PnP PDF Creator"

          # AppleScript: Terminal öffnen & Programm starten
          cat > launcher.applescript <<'APPLESCRIPT'
          on run
              set appName to "PnP PDF Creator"
              set bundlePath to POSIX path of (path to me)
              set toolDir to bundlePath & "Contents/Resources/tool/"
              set exePath to toolDir & appName

              -- Robust: open Terminal and run a login shell, then cd + exec
              set cmd to "cd " & quoted form of toolDir & " && " & quoted form of exePath
              do shell script "open -a Terminal " & quoted form of cmd
          end run
          APPLESCRIPT

          # .app aus dem AppleScript erzeugen
          osacompile -o "PnP PDF Creator.app" launcher.applescript

          # Icon kopieren
          mkdir -p "PnP PDF Creator.app/Contents/Resources"
          cp "PnP_PDF_Creator.icns" "PnP PDF Creator.app/Contents/Resources/applet.icns"

          # PyInstaller-Output in .app einbetten
          mkdir -p "PnP PDF Creator.app/Contents/Resources/tool"
          cp -R "dist/PnP PDF Creator/." "PnP PDF Creator.app/Contents/Resources/tool/"

          # Minimaler Info.plist (optional, falls osacompile sie nicht setzt)
          /usr/libexec/PlistBuddy -c "Set :CFBundleName 'PnP PDF Creator'" "PnP PDF Creator.app/Contents/Info.plist" || true
          /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName 'PnP PDF Creator'" "PnP PDF Creator.app/Contents/Info.plist" || true

          echo "? Wrapper-App erstellt:"
          ls -la "PnP PDF Creator.app"

      # --- 3) Ad-hoc signieren (vermeidet 'beschädigt'-Warnung auf vielen Systemen)
      - name: Wrapper-App ad-hoc signieren
        run: |
          codesign --force --deep --sign - "PnP PDF Creator.app"
          codesign -dv --verbose=2 "PnP PDF Creator.app" || true

      # --- 4) ZIP für schnellen Download (optional beibehalten)
      - name: Wrapper-App als ZIP verpacken
        run: |
          ditto -c -k --sequesterRsrc --keepParent \
            "PnP PDF Creator.app" \
            "PnP_PDF_Creator_macOS_APP.zip"

      # --- 5) DMG erstellen (schönes, benutzerfreundliches Installer-Image)
      - name: DMG erstellen
        run: |
          # Entferne ggf. alte DMG-Datei
          rm -f "PnP_PDF_Creator_macOS.dmg"

          # create-dmg: einfaches Layout mit App und App-Ordner-Link
          create-dmg \
            --volname "PnP PDF Creator" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --hide-extension "PnP PDF Creator.app" \
            --icon "PnP PDF Creator.app" 180 180 \
            --app-drop-link 420 180 \
            "PnP_PDF_Creator_macOS.dmg" \
            "PnP PDF Creator.app"

      # --- 6) DMG ad-hoc signieren (optional; für notarization später ersetzen)
      - name: DMG ad-hoc signieren
        run: |
          codesign --force --sign - "PnP_PDF_Creator_macOS.dmg" || true
          spctl -a -vv "PnP_PDF_Creator_macOS.dmg" || true

      # --- 7) Artefakte hochladen (ZIP + DMG)
      - name: Artefakte hochladen (ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: PnP_PDF_Creator_macOS_APP
          path: PnP_PDF_Creator_macOS_APP.zip

      - name: Artefakte hochladen (DMG)
        uses: actions/upload-artifact@v4
        with:
          name: PnP_PDF_Creator_macOS_DMG
          path: PnP_PDF_Creator_macOS.dmg

      # --- (Optional) GitHub Release erstellen und DMG/ZIP anhängen
      # Aktiviere diesen Schritt, wenn du bei workflow_dispatch gleich ein Release willst.
      # - name: Release erstellen
      #   uses: softprops/action-gh-release@v2
      #   with:
      #     tag_name: v1.3
      #     name: "PnP PDF Creator v1.3"
      #     body: "macOS .app + DMG"
      #     draft: false
      #     prerelease: false
      #     files: |
      #       PnP_PDF_Creator_macOS_APP.zip
      #       PnP_PDF_Creator_macOS.dmg
